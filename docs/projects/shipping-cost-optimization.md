---
title: Shipping cost optimization with dangerous goods penalty
parent: Projects
nav_order: 3
---


# Abstract
{: .no_toc }
{: .d-inline-block }
07-17-2025
{: .label .label-green }

Did you ever wonder how to optimally pack parcels, serving customers with various subscription sizes of while avoiding a dangerous goods shipping penalty fee?
No? Well, me neighter. Let's investigate how its done anyways!
Stay with me, its worth it: We will reduce shipping cost by 40% just by intelligently exploiting the degressive cost-per-weight structure in today's CEP sector and show why shopping-cart bundling is worth it!
We will then end on a generalizing note, rediscovering the knapsack problem along the way.
{: .fs-6 .fw-300 }

---
## Table of contents
{: .no_toc .text-delta }

1. TOC
{:toc}
---

# Introduction
The German logistics market had a total volume of €327 billion in 2023.
This makes logistics the third largest economic sector in Germany after the automotive industry and trade.
Approximately half of the total volume originates from  internal company's logistics.
The other half is generated by dedicated package delivery, courier and transportation companies.
Logistic services are divided into general cargo (traditional pallets, special transports) and the more standardized CEP sector ([DSLV](https://www.dslv.org/de/die-branche/logistikmarkt)).
The transportation companies' CEP sector was reported to make up around 16% of the total revenue and thus generates a turnover of 27 billion euros, which is comparable to the German consumer electronics market ([CEP](https://www.dslv.org/de/die-branche/logistikmarkt)).
In 2023, the CEP sector delivered around 4.51 billion parcels in Germany.
Approximately 50% of this in terms of revenue and number of shipments were delivered by Deutsche Post DHL Group, the world's second-largest logistics company after FedEx ([Transportation companies by size](https://www.ingenieur.de/technik/fachbereiche/logistik/das-sind-die-groessten-logistikunternehmen-der-welt/)).


{: .note-title }
> CEP
>
> The term CEP is the abbreviation for "Courier, Express and Parcel Services". It refers to postal and logistics companies that primarily transport consignments with comparatively low weight and volume - such as letters, small packages, documents or small items. These restrictions on dimensions and weight allow a high degree of standardisation in processing. As a result, the handling and sorting of the objects to be transported can be easily (partially) automated. In this way, consignments can be transported in a short time and with high efficiency.
>([DHL Dictionary](https://dhl-freight-connections.com/en/logistics-dictionary/cep/))

While general cargo transport is the significantly larger sector, it remains largely hidden from consumers, while they mostly experience logistics through the CEP sector e. g. through daily deliveries triggered by orders placed at online marketplaces.

The CEP sector is highly automated and therefore cost-efficient. This is advantageous not just for consumers but especially retail that specializes in B2B or B2C business with the help of distribution through the CEP sector. Since goods are standardized, meaning that there are only a few differentiating factors, not only within a provider but also between providers, providers introduce levels within a feature to artificially force service differentiation and therefore better prices. 
Comparing the differentiation through the category of weight as an example we notice that logistics providers offer up to seven different weight classes withing the 0-31.5 kg range decreasing cost per weight as the total weight increases.

Consumers can only accept the offers and compare between different carriers.
Companies, on the other hand, have a customer base, a range of recurring core products and the ability to align shopping carts and delivery frequencies.
This allows them to take advantage of transportation companies' pricing policies to arrive at the best price possible.
In this work, we show how weight classes, dangerous goods penalties, and order bundling across multiple packages can be used to generate the most cost-effective shipping option.
We then compare a standardized shopping cart with an optimized shopping cart:
The results indicate a reduction of transportation costs by 40%.
We then compare the variable cost proportion attributed to transportation with industry standards.

## CEP sector - weight and girth length
In order for the CEP sector to operate in a particularly cost-efficient manner and offer low prices to consumers, it is highly standardized with parcels meeting strict criteria in order to be processed as CEP.
Three criterias are always applicable:
- weight with most transportation companies delivering parcels up to 31.5kg translating to a maximum goods weight of 30kg (66lbs)
- girth with most transportation companies limiting girth + length between 3000 and 4000 mm
- dangerous goods are generally excluded from CEP transportation unless they are transported in limited quantity, smallest quantities or products that are individually exempt from the dangerous goods transportatin prohibition  according to ADR 3.3, 3.4, 3.5

To ensure that the delivery can be carried out particularly quickly (especially without material handling equipment such as forklifts), packages must not exceed a maximum permissible weight. This varies from provider to provider, but is centered around around 31.5 kg.

{: .note-title }
> Girth / Girth + length
>
> The girth is the maximum permitted parcel size. It is calculated as: girth = 2 x (height + width). Most companies use girth + length =  2 x (height + width) + length to determine the maximum parcel size.
> ([DHL Dictionary](https://dhl-freight-connections.com/en/logistics-dictionary/girth-measurement/), [DPD FAQ](https://www.dpd.com/de/en/faq/was-beutet-gurtmas/))

Girth + length ensures that apart from weight a certain "density" maintained. Space is expensive and girth + length ensures a lower bar on what might be a cheap parcel in terms of wight but taking up overproportionally large space in the transportation vehicles.

Dangerous goods are less an economic category than a legal one, defined by the Agreement of September 30, 1957 concerning the International Carriage of Dangerous Goods by Road, ADR, from 1957 ensuring safe transportation.
This agreement categorizes goods for road transport, defines warning and safety instructions and lists exceptions. Exceptions include:
- simplified transport of certain dangerous goods when carried in small quantities as part of a company’s ancillary activities (e.g., maintenance, repair, construction) according to  Special Provision SV1 (ADR 3.3)
- limited quantities (LQ) allows exemptions from most ADR provisions when dangerous goods are packaged in very small quantities per inner and outer packaging (ADR 3.2)
- Lithium-ion batteries in different sizes according to total capacity, cell size with respect to packaging, and prior certification
- blood and tissue samples when transported in specific packaging and quantity

## Warehouse - every pick matters
While a carrier only provides transportation services and thus assumes that the company itself is in physical possession of the outbound goods, this is not always the case.
Most retailers and manufacturers rely on yet another third party that provides storage space.
Typically this party is referred to as warehouse provider.
Optionally, the warehouse provider also provides order fulfillment.
In case the whole value chain is fullfilled via a third party, one refers to this as third-party-logistics, 3PL.

Warehouses hold space for incoming goods, storage, a dedicated picking system, a packing area and a freight forwarding area. Consequently service providers typically attribute cost for the administration and processing of incoming goods (usually on paletts), the administration of orders, the pick from a palett, the packing into carton and the placing into cargo space. A pick is associated with one product category, regardless of the quantity of the product. The occupied warehouse space is charged on a daily rate.

It makes sense to bundle consecutive orders per customer in order to save on additional picking costs (picking two pieces of the same type is cheaper than picking the same piece two times). Apart from that, the strict billing system, in which every single step is charged individually, leaves little room for cost optimization shifting focus from warehouse back to CEP provider.

{: .note-title }
> 3PL
>
> Third-Party Logistics (3PL) refers to a business model in which a company outsources its logistics processes to an external service provider, a “third party", regardless of the part of the logistics provided. Typically logistic processes are divided into warehousing/storage, usually including the control of incoming and outgoing goods (administration, picking, packing, truck loading) while another party takes care of transportation.
While some companies offer a full-service other companies only provide one or some of the mentioned services.
> ([Red Stag Fulfillment](https://redstagfulfillment.com/3pl-definition-process-resources/))


## The Oater product portfolio and consumable goods
The Oater sells an automated oat drink production machine called The Oater Barista for fresh on-site production of oat drink.
This machine consists of a reactor, water inlet and outlet, a stirrer, and a heating jacket for the reactor as well as various in- and outlets.
During production, a dry mix consisting of oat flour and enzymes is suspended in an aqueous solution on site for simultaneous starch degradation and saccharification.
After saccharification, oil is dispersed into the solution.
Once the ready-to-consume product has been dispensed, The Oater Barista doses a cleaning agent into the reactor and starts a cleaning cycle.
The Oater Barista's batch production is patented. Interested? [Read on here](https://auerbenji.github.io/docs/blog/the-oater-is-patented/).

Dry mix, oil and cleaning agent are sent to the customer on a monthly basis.
The quantities depend on the customer's consumption volume which they can adjust in an online shop as a subscription size between 80 liters and 500 liters of oat drink per month.
Dry mix, oil, and cleaning agent are only available in a single container size.
The cleaning agent is classified as dangerous good according to ADR 3.2 under the UN-number 1719 and thus transportation by CEP is only permitted in containers not exceeding one liters.

# Methodology
The The Oater Barista machine uses exactly 1 dry mix pouch, 1/5 of an oil bottle and 1/9 of a cleaning agent bottle to produce 4.5 liters of oat drink in a single production cycle.
Consequently
- one pouch of dry mix is sufficient to produce 4.5 liters of oat drink
- one bottle of oil is sufficient to produce 22.5 liters of oat drink
- one bottle of cleaning detergent is sufficient to produce 40.5 liters of oat drink.

We notice that not only the consumable goods' weight must be taken into account but the gross weight including paper pouch and bottle weight. While the weight difference might be neglectable for paper pouch and detergent plastic bottle, the oil is shipped in a glas bottle making up around half of the gross oil's  weight.
Furthermore, only complete quantities may be shipped.
This causes ceiling for each subscription size and consumable.
This effects mostly small subscription sizes.

Given a known customer's subscription size and a known shipping-cost-to-weight vector and known dangerous goods penalty, as well known costs for warehousing service we want to find the packing rule that yields minimal logistics costs.
We assume that girth size is never a limiting factor due to the high density of the individual products.

As a starting point we place all cleaning agent bottles in a single parcel so that the penalty is only paid once.
However, the discreet nature of the different weith of the product classes means that it may no longer be possible to make particularly precise use of the shipping weight, as the weight unit of the cleaning detergent is no longer available.
Furthermore, the degressive cost structure of shipping costs makes it more attractive to pack two medium-weight packages than one very heavy and one light package.
It renders obvious that there is no simple heuristic or packing instruction that guarantees minimal shipping costs. We will therefore proceed to mathematical optimization to minimize shipping cost.

**Mathematical optimization**, also known as mathematical programming is the art of selecting of the best solution, given a set of conditions that have to hold true (equality constraints) as well as a set of conditions that may vary in a given range (inequality constraints).
The nature of the variables involved in the cost function and in the constraints define the problem category and thus the solution approach. Mathematical programming is used everywhere, from routing problems, AI training and shipping cost optimization to advanced process control and has equal origins in the chemical engineering community as well as in operations research. Mathematical optimization has emerget to provide solution strategies to deal with bi-level problems (optimization problems that are subject to another optimization problem), uncertainty (both stochastic and worst case) as well as many more "special" cases.
It takes more than a lifetime to learn all about it.
The interested reader is directed to my former Professor Stratos Pistikopoulos who taught me optimization (see [Parametric](https://parametric.tamu.edu/)) as well as his dear collegues in the field such as Professor Alexander Mitsos (see [SVT](https://www.avt.rwth-aachen.de/cms/AVT/Forschung/Systemverfahrenstechnik/~ipqz/Prozessregelung/lidx/1/)). Furthermore I suggest reading articles in [CACE](https://www.sciencedirect.com/journal/computers-and-chemical-engineering), and [EJOR](https://www.sciencedirect.com/journal/european-journal-of-operational-research), both great journal to follow and inspire how engineering problems are solved via optimization.

## Cost of goods
We base the solution algorithm on the price per liter of produced oat drink and define a known monthly subscription model size $$a$$.
The known number of oat packs $$N_T$$, oil bottles $$N_O$$ and cleaning agent bottles $$N_R$$ are consequently given by ceiling to the largest natural number that statisfies $$a$$ and are stored in $$N$$:
- $$ N_T =  \left\lceil a/4.5 \right\rceil $$
- $$ N_O = \left\lceil a/22.5 \right\rceil $$
- $$ N_R = \left\lceil a/40.5 \right\rceil $$

where $$ N = [N_T \quad N_O \quad N_R] \in \mathbb{N^3} $$. Consequently the number of species subject to optimization is $$N_S=3$$.
Each item has a known weight $$w = [w_T, w_O, w_R]^\top$$ in kilo gram, and a known cost-per-piece $$c = [c_T, c_O, c_R]^\top$$ in Euro.


## Carrier cost
Carrier cost can be obtained by the multiplication of a cost-per-weight vector with a distribution matrix holding the content of each parcel.

### Shipping cost vector
The shipping cost vector holds the price-per-parcel within the associated shipping weight class.
We remove 1.5 kg from each parcel to account for carton and filling weight.

$$
V =
\begin{bmatrix}
SC & SW \\
\end{bmatrix}^\top =
\begin{bmatrix}
0     & 0 \\
3.62  & 1.5 \\
4.17  & 3.5 \\
4.83  & 8.5 \\
6.30   & 13.5 \\
6.85  & 18.5 \\
7.02  & 23.5 \\
7.29  & 30
\end{bmatrix}^\top
$$

The length of $$V$$ is the number of different weight/cost categories provided by the CEP, here $$N_V= 8$$, as we include the null-weight/cost as a convenient way to attribute zero cost associated with an empty, never packed parcel.
Last we define the dangerous goods shipping cost penalty as $$\phi=3.5$$ as a one-time fee added to each parcel that contains $$\geq1$$ cleaning detergent bottles.

### Parcel content and weight
In oder to calculate the weight efficiently we introduce the distribution matrix $$D \in [N_S, N_T+N_O+N_R=N_L] $$ holding the number of items per species per parcel. As an upper bound for the number of parcels necessary to ship all items we conveniently use the sum of all individual items.
Additionally, we introduce the cost category matrix $$C \in [N_V, N_L]$$ a zero-matrix consisting of zeros exept for the respective cost category of each parcel denoted with a $$1$$.
We lastly define a penalty vector $$\Phi \in [N_L]$$ holding zeros for each parcel except for ones for the parcel that hold $$\geq1$$ cleaning detergent bottles. Consequently $$\Phi$$ is a binary optimization variable.

## Warehouse cost
Warehouse cost assume that each subscription triggers only one monthly "warehouse run", even if the total shopping cart is then packed in more than one parcel.
For ease of understanding we separate the warehouse cost $$c_{\text{warehouse}}$$:

- $$ c_{\text{warehouse}} = c_{3PL}+c_{\text{parcel}} $$
- $$ c_{\text{3PL}} = c_A + c_P \cdot N_S $$
- $$ c_{\text{parcel}} = c_p \cdot \sum^P \sum^C C_{c,p} $$

where $$c_A$$ is the per-subscription order administration fee and $$c_P$$ is the per-pick fee. Both fees are known and warehouse provider dependent.
$$c_p$$ is a warehouse provider dependent cost associated with carton, filling and freight farwarding of each parcel and is thus multiplied with the number of parcels that servce the monthly subscription.
To conveniently grasp the number of parcels we rely on $$C$$.

## Cost function
The cost to serve ($$CTS$$) of one liter of oat-drink is the sum of the cost of goods $$CG$$, the carrier cost $$CC$$ and the warehouse cost $$WC$$:

$$CTS(V,\phi) = \min_{D,\Phi,C} \frac{1}{a} (CG + CC + WC)$$

and are a function of the shipping-cost vector and the penalty fee. We assume $$N$$ not to be subject to optimization. Inserting the discrete terms for each associated cost the cost function becomes


$$CTS(V,\phi) = \min_{D,\Phi,C} \frac{1}{a} (N \cdot c + \sum^C\sum^P SC_c \cdot C_{c,p} + \sum^P \phi \cdot \Phi_p + c_A + c_P \cdot N_S + c_p \cdot \sum^C \sum^P C_{c,p}) $$

We optimize for the lowest possible cost to serve and calculate the fractions of $$CG, CC, WC$$ in post-processing.

## Shipping cost problem

The shipping cost problem is given as

$$
\begin{align}
CTS(V,\phi) &= \min_{D,\Phi,C} \frac{1}{a} (N \cdot c + \sum^C\sum^P SC_c \cdot C_{c,p} + \sum^P \phi \cdot \Phi_p + c_A + c_P \cdot N_S + c_p \cdot \sum^C \sum^P C_{c,p}) \tag{a}\\
\text{s. t.} \quad \sum^P D_{s,p} &= N_s \quad \forall s \in S \tag{b}\\
\sum^C C_{c,p} &= 1 \quad \forall p \in P \tag{c}\\
\sum^S D_{s,p} \cdot w_s &\leq SW_1 \cdot C_{1,p} + SW_{N_V} \cdot (1 - C_{1,p}) \quad \forall p \in P \tag{d}\\
SW_{c-1} \cdot C_{c,p} &\leq \sum^S D_{s,p} \cdot w_s \quad \forall p \in P, c \in C \setminus [1] \tag{e}\\
\sum^S D_{s,p} \cdot w_s &\leq SW_c \cdot C_{c,p} + SW_{N_V} \cdot (1 - C_{c,p}) \quad \forall p \in P, c \in C \setminus [1] \tag{f}\\
D_{N_S,p} &\leq N_R \cdot \Phi_p \quad \forall p \in P \tag{g}
\end{align}
$$

Equation (b) guarantees that all items are shipped to the customer and equation (c) ensures only one weight category may be selected.
Equation (d) serves a double purpose: first it provides a null-cost category, representing an empty and thus unshipped parcel. Additionally, in case the parcel is not empty, the maximum admmidable parcel weight is set as an upper bound.
Equation (e,f) finally select the correct cost category.
Notice that equation (e)'s the RHS of equation (e) is the LHS of equation (f).
The statement is split and then handed to the optimizer.
Lastly equation (g) sets the penalty pin in case cleaning detergent is shipped.
Notice that the cost function then sums over all penalty pins.

### Solution strategy
The shipping cost problem holds linear terms as well as integer decision variables only.
While $$D$$ holds an integer decision variables; $$C, \Phi$$ hold binary decision variables.
Thus, the shipping cost problem is an integer programming problem and can be solved with standard IP solvers.
The problem was solved with Gurobi Optimizer version 10.0.3 on an Apple M3 Pro SoC running 12 threads with 18GB RAM in Visual Studio version 1.101.2. The model consists of 1140 integer decision variables of which 855 are binaries for a subscription size of 320 liters.
Although the model holds $$\approx 10^3 $$ binaries, $$M \leq 1e-5$$ in the big-M constraint $$y \leq Mb$$, thus we omit setting Gurobis IntegralityFocus parameter saving runtime.
The model solved to optimality in 0.04 seconds for generation and 0.17 seconds for optimization.
This is remarkably fast: notice shipping cost optimization extends bin packing, itself an extension of the NP-hard knapsack problem.
The subscription size of 1000 liters per month size was solved to optimality in 0.10 seconds for generation and 0.83 seconds for optimization.
Consequently we will not investigate runtime improvement through problem reformulation noting that Gurobi does an excellent job at presolving and facilitating the problem before optimization.

{: .note-title }
> Information
>
> I will add a follow-up investigating runtime, solving the shipping cost problem in Julia using JuMP, ORTools CP-SAT and HiGHS. Come back later. Not that my publication on [flexibility](https://auerbenji.github.io/docs/publications/algorithmic-advances-in-flexibility-analysis/) already investigated the reformulation of big-M constraints, using SOS1 constraints instead.


# Results and discussion

<figure id="fig-cost-by-cat">
  <img src="/assets/images/cost-of-species.svg" alt="Cost by category">
  <figcaption><strong>Figure 1:</strong> Shipping cost optimization: cost by category</figcaption>
</figure>

[Figure 1](#fig-cost-by-cat) shows the cost by categoy and its proportion.



<figure id="fig-relative-savings">
  <img src="/assets/images/relative-savings.svg" alt="Relative warehouse and carrier savings">
  <figcaption><strong>Figure 2:</strong> Shipping cost optimization: relative warehouse and carrier savings</figcaption>
</figure>

[Figure 2](#fig-cost-by-cat) shows the relative savings for warehouse and carrier.



<figure id="fig-cost-by-cat">
  <img src="/assets/images/parcel-value.svg" alt="Levelized parcel value">
  <figcaption><strong>Figure 3:</strong> Shipping cost optimization: levelized parcel value.</figcaption>
</figure>

[Figure 3](#fig-parcel-value) shows the levelized parcel value and the number of parcels that serve the subscription model.

# References
